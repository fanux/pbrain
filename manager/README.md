## 插件式调度策略说明文档

## 系统架构
```
   +-------------------------+
   |      web dashboard      |
   +-------------------------+
             |        |                                 
             |        V                            
             |    +----------+
             |    | shipyard |          +------------+
  message    |    +----------+<-------->|            |
  bus        V                          |   swarm    |
  |  | pub+------------------+          |  cluster   |
  |  |<---| plugin manager   |<-------->|            |
  |  |    +----^-------------+          +------------+
  |  |         |
  |  | sub+----V------+
  |  |--->|  plugin   |
  |  |    +-----------+
```
* dashboard通过web界面对集群进行管理，如容器管理，镜像管理，节点管理，仓库管理，插件管理
* 除插件管理以外的功能通过复用开源软件shipyard实现
* plugin manager是一个单独的进程，扩展了shipyard的一些功能，主要是插件管理功能
* plugin是具体某个插件,也是单独的进程，通过http请求获取插件的信息以及获取策略文档
* 插件管理器通过消息总线主动通知插件一些事件，如插件策略有更新，插件被启用/禁用等

## 名词解释
* 插件 (plugin) 通过解析策略文档，决定怎样执行一个动作。包含一个唯一的插件名
* 策略 (strategy) 一个插件包含一个或多个插件策略，每个策略也包含一个唯一的策略名和一个策略文档（最为重要） 
* 策略文档 (strategy document) 特定策略的配置文档，在满足什么样的条件下做什么样的事情
* 手册 (manual) 怎么配置策略文档，各种字段含义是什么，配置事例等. 每个插件对应一个配置手册

对应关系：
    插件----策略1----策略文档1
          |-策略2----策略文档2
          |-策略3----策略文档3

不同的插件策略文档的格式不同，
同一个插件的不同策略文档格式相同，取值不同

## 设计目的，策略与执行分离
插件管理器不解析策略文档，各种各样的策略配置只有插件本身能够解析，解析完告诉管理器执行哪个动作即可

## 时间流插件 plugin_pipeline介绍

1. 在web界面上创建一个叫plugin_pipeline的插件，再创建一个策略叫scadule-hour-by-hour
2. 配置策略文档，内容如下：
```json
[
    {    
        "Cron":"* * 0 * * *",
        "Apps":[
            {
                "App":"ats",
                "Number":20
            },
            {
                "App":"hadoop:latest",
                "Number":10
            }
        ]
    },
    {    
        "Cron":"* * 1 * * *",
        "Apps":[
            {
                "App":"ats",
                "Number":10
            },
            {
                "App":"hadoop:latest",
                "Number":20
            }
        ]
    }
]
```
文档含义:
* Cron: 兼容linux crontab的配置格式，扩展了秒位。
```
*   5      *       *         *     *     ls             指定每小时的第5分钟执行一次ls命令
*   30     5       *         *     *     ls             指定每天的 5:30 执行ls命令
*   30     7       8         *     *     ls             指定每月8号的7：30分执行ls命令
*   30     5       8         6     *     ls             指定每年的6月8日5：30执行ls命令
*   30     6       *         *     0     ls             指定每星期日的6:30执行ls命令[注：0表示星期天，1表示星期1，
```
```  
*  30  3  10,20  *   *   ls     每月10号及20号的3：30执行ls命令[注：“，”用来连接多个不连续的时段]

*  25  8-11 *    *   *   ls     每天8-11点的第25分钟执行ls命令[注：“-”用来连接连续的时段]

*  */15 *   *    *   *   ls     每15分钟执行一次ls命令 [即每个小时的第0 15 30 45 60分钟执行ls命令 ]

*  30   6   */10 *   *   ls     每个月中，每隔10天6:30执行一次ls命令[即每月的1、11、21、31日是的6：30执行一次ls 命令。 ]

```
* 所以上面的文档含义为：每天0点的时候运行20个ats业务，10个hadoop业务，每天1的时候运行10个ats，20个hadoop业务

3. 在界面上创建策略后会将请求POST给plugin manager, plugin manager将信息写入数据库

4. 启动plugin_pipeline插件，插件启动时会去向plugin manager请求获取策略文档。

5. 插件解析策略文档，执行定时任务.  到0点时插件会向plugin manager发送一个请求：
POST /plugins/scale

BODY:
```json
[
    {
        "app":"ats",
        "num":20,
    },
    {
        "app":"hadoop",
        "num":10
    }
]
```
这就是一个执行动作（任务）,目前manager支持的唯一一个动作。后面可扩展新的动作，如插件有更复杂的请求也可调用其它的api

6. plugin manager 接受到请求后执行逻辑：

实例化一个容器计数器, 是一个map:
```
{
    "ats":{0, 20, ""},    //三个数值含义依次是：当前运行ats容器数量，需要运行的数量，容器id
    "haddop":{0, 10, ""}
}
```
```
    Current    Need     ContainerId
"ats":{0,       20,       ""}
```

获取容器列表，遍历列表,如果是map中的业务则Current++

如果Current > Need 表示当前运行的数量超过了我们想要运行的，那么remove这个容器

这样遍历结束后就完成了“缩“这个过程，资源都释放出来了，接下来”伸“

遍历 map 

如果 Need > Current 再启动 Need - Current个容器（上面我们设置了容器id）

值得注意的是伸缩的次序，因为所有资源都是被占用的，一定要先缩后伸，否则很大可能性会失败.

## 顺序图
```
dashboard              plugin_pipeline                 plugin manager            swarm         
   |     create plugin       |                               |                     |
   |-------------------------------------------------------->|                     |
   |                         |       get plugin strategy     |                     |
   |                         |<------------------------------|                     |
   |                  +------|                               |                     |
   |        analyse   |      |                               |                     |
   |        strategy  +----->|     POST /plugins/scale       |                     |
   |                         |------------------------------>|                     |
   |                         |                               |     GET containers  |
   |                         |                               |-------------------->|
   |                         |                               |<--------------------|
   |                         |                               |   Remove containers |
   |                         |                               |-------------------->|
   |                         |                               |   deploy containers |
   |                         |                               |-------------------->|
   |                         |                               |                     |
   |                         |                               |                     |
   V                         V                               V                     V
```
